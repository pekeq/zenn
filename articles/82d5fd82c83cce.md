---
title: "YubiKeyã®OpenPGPæ©Ÿèƒ½ã§ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆã«SSHãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¾ã§"
emoji: "ğŸ—ï¸"
type: "tech"
topics: ["ssh","openpgp","gpg","yubikey"]
published: true
---
2021å¹´7æœˆç¾åœ¨ã€‚
MacOS, YubiKey 5Cã§ç¢ºèªã€‚

# æµã‚Œ

1. å¿…è¦ãªã‚½ãƒ•ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. æ¥•å††æš—å·(ed25519)ã‚’ä½¿ã†ã‚ˆã†ã«è¨­å®š
3. ã‚­ãƒ¼ã®ç”Ÿæˆ
4. gpg-agentã®è¨­å®š
5. PINã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‹ã‚‰å¤‰æ›´
6. SSHå…¬é–‹éµã‚’è¡¨ç¤ºã—ã¦ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆã«è¿½åŠ 

# 1. å¿…è¦ãªã‚½ãƒ•ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚‚ã®ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

- [GPGTools](https://gpgtools.org/)
  - Homebrewç­‰ã§gpgã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆã¯äº‹å‰ã«ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠã
  - å¾Œè¿°ã®é€šã‚Šã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯¾è±¡ã‹ã‚‰GPG Mailã‚’å¤–ã—ã¦ãŠãã¨ã‚ˆã„
- [YubiKey Manager CLI](https://github.com/Yubico/yubikey-manager)
  - Homebrewãªã‚‰ `brew install ykman` ã§å…¥ã‚‹
  - ãªãã¦ã‚‚SSHãƒ­ã‚°ã‚¤ãƒ³ã¾ã§ã¯ã§ãã‚‹ãŒã€ã‚ã£ãŸæ–¹ãŒä¾¿åˆ©

## GPGToolsã‚’å…¥ã‚Œã‚‹ã¨ãã¯ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§GPG Mailã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªã„

GPG Mailæ©Ÿèƒ½ã¯æœ‰å„Ÿæ©Ÿèƒ½ãªã®ã§ã€ä½¿ã‚ãªã„ã®ã§ã‚ã‚Œã°ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãŠãã€‚

![ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”»é¢](https://storage.googleapis.com/zenn-user-upload/489cc9d25137d3cedff05a3d.png)

# 2. æ¥•å††æš—å·(ed25519)ã‚’ä½¿ã†ã‚ˆã†ã«è¨­å®š

`gpg --card-edit` ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«å…¥ã£ã¦ã€ `admin` ã§ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆãŸå¾Œã€ã€€`key-attr` ã§å¤‰æ›´ã™ã‚‹ã€‚

```shell
$ gpg --card-edit

Reader ...........: Yubico Yubikey 4 OTP U2F CCID
Application ID ...: 00000000000000000000000000000000
Application type .: OpenPGP
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 00000000
Name of cardholder: [æœªè¨­å®š]
Language prefs ...: [æœªè¨­å®š]
Salutation .......: 
URL of public key : [æœªè¨­å®š]
Login data .......: [æœªè¨­å®š]
Signature PIN ....: å¼·åˆ¶ãªã—
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 0
KDF setting ......: off
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]

gpg/card> admin
ç®¡ç†è€…ã‚³ãƒãƒ³ãƒ‰ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™
gpg/card> key-attr
ã“ã¡ã‚‰ã®ã‚«ãƒ¼ãƒ‰éµã®å±æ€§ã‚’å¤‰æ›´ã—ã¾ã™: ç½²åéµ
ã”å¸Œæœ›ã®éµã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„:
   (1) RSA
   (2) ECC
ã‚ãªãŸã®é¸æŠã¯? 2
ã”å¸Œæœ›ã®æ¥•å††æ›²ç·šã‚’é¸æŠã—ã¦ãã ã•ã„:
   (1) Curve 25519
   (4) NIST P-384
ã‚ãªãŸã®é¸æŠã¯? 1
ã‚«ãƒ¼ãƒ‰ã¯ã€ä»Šã€ã“ã¡ã‚‰ã®ã‚¿ã‚¤ãƒ—ã®éµã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«å†ã‚³ãƒ³ãƒ•ã‚£ã‚°ã•ã‚Œã¾ã™: ed25519
(PINã‚’å…¥åŠ›)
æ³¨æ„: ã‚«ãƒ¼ãƒ‰ãŒè¦æ±‚ã•ã‚ŒãŸéµé•·ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã¨ã„ã†ä¿è¨¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
      éµç”ŸæˆãŒæˆåŠŸã—ãªã„å ´åˆã€ã‚ãªãŸã®ã‚«ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹æŠ€è¡“æ–‡æ›¸ã‚’ç¢ºèªã—ã€
      åˆ©ç”¨ã§ãã‚‹éµé•·ã«ã¤ã„ã¦ç¢ºèªãã ã•ã„ã€‚
ã“ã¡ã‚‰ã®ã‚«ãƒ¼ãƒ‰éµã®å±æ€§ã‚’å¤‰æ›´ã—ã¾ã™: æš—å·åŒ–éµ
ã”å¸Œæœ›ã®éµã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„:
   (1) RSA
   (2) ECC
ã‚ãªãŸã®é¸æŠã¯? 2
ã”å¸Œæœ›ã®æ¥•å††æ›²ç·šã‚’é¸æŠã—ã¦ãã ã•ã„:
   (1) Curve 25519
   (4) NIST P-384
ã‚ãªãŸã®é¸æŠã¯? 1
ã‚«ãƒ¼ãƒ‰ã¯ã€ä»Šã€ã“ã¡ã‚‰ã®ã‚¿ã‚¤ãƒ—ã®éµã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«å†ã‚³ãƒ³ãƒ•ã‚£ã‚°ã•ã‚Œã¾ã™: cv25519
(PINã‚’å…¥åŠ›)
ã“ã¡ã‚‰ã®ã‚«ãƒ¼ãƒ‰éµã®å±æ€§ã‚’å¤‰æ›´ã—ã¾ã™: èªè¨¼éµ
ã”å¸Œæœ›ã®éµã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„:
   (1) RSA
   (2) ECC
ã‚ãªãŸã®é¸æŠã¯? 2
ã”å¸Œæœ›ã®æ¥•å††æ›²ç·šã‚’é¸æŠã—ã¦ãã ã•ã„:
   (1) Curve 25519
   (4) NIST P-384
ã‚ãªãŸã®é¸æŠã¯? 1
ã‚«ãƒ¼ãƒ‰ã¯ã€ä»Šã€ã“ã¡ã‚‰ã®ã‚¿ã‚¤ãƒ—ã®éµã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«å†ã‚³ãƒ³ãƒ•ã‚£ã‚°ã•ã‚Œã¾ã™: ed25519
(PINã‚’å…¥åŠ›)

gpg/card> list

Reader ...........: Yubico Yubikey 4 OTP U2F CCID
Application ID ...: 00000000000000000000000000000000
Application type .: OpenPGP
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 00000000
Name of cardholder: [æœªè¨­å®š]
Language prefs ...: [æœªè¨­å®š]
Salutation .......: 
URL of public key : [æœªè¨­å®š]
Login data .......: [æœªè¨­å®š]
Signature PIN ....: å¼·åˆ¶ãªã—
Key attributes ...: ed25519 cv25519 ed25519
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 0
KDF setting ......: off
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
```

# 3. ã‚­ãƒ¼ã®ç”Ÿæˆ

ä»¥ä¸‹ã®æ‰‹é †ã§ã¯ã€ç§˜å¯†éµã‚’YubiKeyã®ã»ã‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ« (`~/.gnupg/sk_xxxx.gpg`) ã«ã‚‚ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¡ãƒ‡ã‚£ã‚¢ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ç­‰ã—ãŸã‚‰ã€å®‰å…¨ã®ãŸã‚å‰Šé™¤ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

ã“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã¯ "This is a shim backup of the private key, not a full backup, and cannot be used to restore to a new YubiKey." ã¨ã„ã†ã“ã¨ãªã®ã§ã€ã“ã‚Œã‚’ä½¿ã£ã¦å…¨ãåŒã˜å†…å®¹ã®YubiKeyã‚’ä½œã‚‹ã®ã¯ç„¡ç†ãªã‚ˆã†ã§ã™ã€‚
å‚è€ƒ: [Using Your YubiKey with OpenPGP](https://support.yubico.com/hc/en-us/articles/360013790259-Using-Your-YubiKey-with-OpenPGP)


```shell
$ gpg --card-edit

Reader ...........: Yubico Yubikey 4 OTP U2F CCID
Application ID ...: 00000000000000000000000000000000
Application type .: OpenPGP
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 00000000
Name of cardholder: [æœªè¨­å®š]
Language prefs ...: [æœªè¨­å®š]
Salutation .......: 
URL of public key : [æœªè¨­å®š]
Login data .......: [æœªè¨­å®š]
Signature PIN ....: å¼·åˆ¶ãªã—
Key attributes ...: ed25519 cv25519 ed25519
Max. PIN lengths .: 127 127 127
PIN retry counter : 5 0 5
Signature counter : 0
KDF setting ......: off
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]

gpg/card> admin
ç®¡ç†è€…ã‚³ãƒãƒ³ãƒ‰ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™

gpg/card> generate
æš—å·åŒ–éµã®ã‚«ãƒ¼ãƒ‰å¤–ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã‹? (Y/n) y

å·¥å ´è¨­å®šã®PINã¯ä¸‹è¨˜ã®ã¨ãŠã‚Š
   PIN = '123456'     ç®¡ç†è€…PIN = '12345678'
æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦å¤‰æ›´ã™ã¹ãã§ã™ --change-pin

(PINã‚’å…¥åŠ›)

éµã®æœ‰åŠ¹æœŸé™ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
         0 = éµã¯ç„¡æœŸé™
      <n>  = éµã¯ n æ—¥é–“ã§æœŸé™åˆ‡ã‚Œ
      <n>w = éµã¯ n é€±é–“ã§æœŸé™åˆ‡ã‚Œ
      <n>m = éµã¯ n ã‹æœˆé–“ã§æœŸé™åˆ‡ã‚Œ
      <n>y = éµã¯ n å¹´é–“ã§æœŸé™åˆ‡ã‚Œ
éµã®æœ‰åŠ¹æœŸé–“ã¯? (0)
éµã¯ç„¡æœŸé™ã§ã™
ã“ã‚Œã§æ­£ã—ã„ã§ã™ã‹? (y/N) y

GnuPGã¯ã‚ãªãŸã®éµã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã«ãƒ¦ãƒ¼ã‚¶IDã‚’æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

æœ¬å: Hideo Matsumoto
é›»å­ãƒ¡ãƒ¼ãƒ«ãƒ»ã‚¢ãƒ‰ãƒ¬ã‚¹: aaa@gmail.com
ã‚³ãƒ¡ãƒ³ãƒˆ: 
æ¬¡ã®ãƒ¦ãƒ¼ã‚¶IDã‚’é¸æŠã—ã¾ã—ãŸ:
    "Hideo Matsumoto <aaa@gmail.com>"

åå‰(N)ã€ã‚³ãƒ¡ãƒ³ãƒˆ(C)ã€é›»å­ãƒ¡ãƒ¼ãƒ«(E)ã®å¤‰æ›´ã€ã¾ãŸã¯OK(O)ã‹çµ‚äº†(Q)? o
(Admin PINã‚’å…¥åŠ›)
(PINã‚’å…¥åŠ›)
(Keyã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›)
ãŸãã•ã‚“ã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ»ãƒã‚¤ãƒˆã®ç”ŸæˆãŒå¿…è¦ã§ã™ã€‚ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æ‰“ã¤ã€ãƒã‚¦ã‚¹ã‚’å‹•ã‹
ã™ã€ãƒ‡ã‚£ã‚¹ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãªã©ã®ä»–ã®æ“ä½œã‚’ç´ æ•°ç”Ÿæˆã®é–“ã«è¡Œã†ã“ã¨ã§ã€ä¹±æ•°ç”Ÿ
æˆå™¨ã«ååˆ†ãªã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ã‚’ä¾›çµ¦ã™ã‚‹æ©Ÿä¼šã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
gpg: æ³¨æ„: ã‚«ãƒ¼ãƒ‰éµã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒ'/Users/pekeq/.gnupg/sk_AE3B7B2E9C4DA650.gpg'ã¸ä¿å­˜ã•ã‚Œã¾ã™
gpg: /Users/pekeq/.gnupg/trustdb.gpg: ä¿¡ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã§ãã¾ã—ãŸ
gpg: éµ56FA46D6CDF41DD9ã‚’ç©¶æ¥µçš„ã«ä¿¡ç”¨ã™ã‚‹ã‚ˆã†è¨˜éŒ²ã—ã¾ã—ãŸ
gpg: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª'/Users/pekeq/.gnupg/openpgp-revocs.d'ãŒä½œæˆã•ã‚Œã¾ã—ãŸ
gpg: å¤±åŠ¹è¨¼æ˜æ›¸ã‚’ '/Users/pekeq/.gnupg/openpgp-revocs.d/4FCB1E1B5159B15DB8C6515356FA46D6CDF41DD9.rev' ã«ä¿ç®¡ã—ã¾ã—ãŸã€‚
å…¬é–‹éµã¨ç§˜å¯†éµã‚’ä½œæˆã—ã€ç½²åã—ã¾ã—ãŸã€‚

gpg/card> list

Reader ...........: Yubico Yubikey 4 OTP U2F CCID
Application ID ...: 00000000000000000000000000000000
Application type .: OpenPGP
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 00000000
Name of cardholder: [æœªè¨­å®š]
Language prefs ...: [æœªè¨­å®š]
Salutation .......: 
URL of public key : [æœªè¨­å®š]
Login data .......: [æœªè¨­å®š]
Signature PIN ....: å¼·åˆ¶ãªã—
Key attributes ...: ed25519 cv25519 ed25519
Max. PIN lengths .: 127 127 127
PIN retry counter : 5 0 5
Signature counter : 4
KDF setting ......: off
Signature key ....: 4FCB 1E1B 5159 B15D B8C6  5153 56FA 46D6 CDF4 1DD9
      created ....: 2021-07-26 12:18:04
Encryption key....: FEF1 CBEF 8C7B 7D6E 5D03  CEEE AE3B 7B2E 9C4D A650
      created ....: 2021-07-26 12:18:04
Authentication key: 250E 3ED6 DBD2 199A FCED  E9B7 7756 2B3C 6540 2756
      created ....: 2021-07-26 12:18:04
General key info..: 
pub  ed25519/56FA46D6CDF41DD9 2021-07-26 Hideo Matsumoto <aaa@gmail.com>
sec>  ed25519/56FA46D6CDF41DD9  ä½œæˆ: 2021-07-26  æœ‰åŠ¹æœŸé™: ç„¡æœŸé™    
                                ã‚«ãƒ¼ãƒ‰ç•ªå·: 0006 00000000
ssb>  ed25519/77562B3C65402756  ä½œæˆ: 2021-07-26  æœ‰åŠ¹æœŸé™: ç„¡æœŸé™    
                                ã‚«ãƒ¼ãƒ‰ç•ªå·: 0006 00000000
ssb>  cv25519/AE3B7B2E9C4DA650  ä½œæˆ: 2021-07-26  æœ‰åŠ¹æœŸé™: ç„¡æœŸé™    
                                ã‚«ãƒ¼ãƒ‰ç•ªå·: 0006 00000000
```

# 4. gpg-agentã®è¨­å®š

```shell
$ vi ~/.gnupg/gpg-agent.conf
$ vi ~/.bash_profile
```

`~/.bash_profile` ã‚’ç·¨é›†ã—ãŸã‚‰ä¸€æ—¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‰ã˜ã¦é–‹ãç›´ã™ã€‚

```text:gpg-agent.conf
pinentry-program /usr/local/MacGPG2/libexec/pinentry-mac.app/Contents/MacOS/pinentry-mac
enable-ssh-support
```

```bash:.bash_profile
export GPG_TTY=$(tty)
gpgconf --launch gpg-agent
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
```

# 5. PINã‚’å¤‰æ›´

```shell
$ gpg --change-pin
gpg: OpenPGPã‚«ãƒ¼ãƒ‰no. 00000000000000000000000000000000ã‚’æ¤œå‡º

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

ã‚ãªãŸã®é¸æŠã¯? 1
PIN changed.
(å¤ã„PINã‚’å…¥åŠ›)
(æ–°ã—ã„PINã‚’å…¥åŠ›)

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

ã‚ãªãŸã®é¸æŠã¯? q
```

# 6. SSHå…¬é–‹éµã‚’è¡¨ç¤ºã—ã¦ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆã«è¿½åŠ 

YubiKeyã‚’å·®ã—è¾¼ã‚“ã çŠ¶æ…‹ã§ `ssh-add -L` ã‚’å®Ÿè¡Œã™ã‚‹ã€‚è¡¨ç¤ºã•ã‚ŒãŸå†…å®¹ã‚’ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã„ãƒ›ã‚¹ãƒˆã® `~/.ssh/authorized_keys` ã«è¿½åŠ ã™ã‚‹ã€‚

```shell
$ ssh-add -L
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINttNOgYMUfCU/yKL28fyuPHlRYMzZX9YjviTqo4gM8P cardno:000600000000
```

sshã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹éš›ã¯ã€USBã«YubiKeyã‚’æŒ¿ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«PINã‚’å…¥åŠ›ã™ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã€‚

# ãã®ä»–ã®æƒ…å ±

## åˆå¿ƒè€…(=ç§)ãŒã‚„ã‚ŠãŒã¡ãª(=ã‚„ã£ãŸ)ãƒŸã‚¹ãƒ»èª¤è§£

- YubiKeyã®PIVæ©Ÿèƒ½ã¨OpenPGPæ©Ÿèƒ½ã¯åˆ¥ç‰©
  - PIVæ©Ÿèƒ½ã§è¨­å®šã—ãŸPINã¯ã€OpenPGPã®PINã¨ã¯å…¨ãé–¢ä¿‚ãªã„

## ã€Œä»¥ä¸‹ã®ã‚·ãƒªã‚¢ãƒ«ç•ªå·ã®ã‚«ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¦ãã ã•ã„ã€ã¨è¡¨ç¤ºã•ã‚Œã¦PINãŒå…¥åŠ›ã§ããªã„å ´åˆ

SSHã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹éš›ãªã©ã«ã€ã€Œä»¥ä¸‹ã®ã‚·ãƒªã‚¢ãƒ«ç•ªå·ã®ã‚«ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¦ãã ã•ã„ã€ã¨ç¹°ã‚Šè¿”ã—è¡¨ç¤ºã•ã‚Œã€YubiKeyã‚’æŠœãå·®ã—ã™ã‚‹ç­‰ã—ã¦ã‚‚æ¬¡ã«é€²ã‚ãªã„å ´åˆã€ `~/.gnupg/private-keys-v1.d` ã‚’å‰Šé™¤ã™ã‚‹ã¨æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

[gpg2: How to get rid of â€œPlease insert card with serial numberâ€, getting the same key from a different card / Yubikey](https://security.stackexchange.com/q/223054/261808)

## YubiKeyã®OpenPGPé–¢é€£æƒ…å ±ã‚’è¡¨ç¤º

`gpg --card-status` ã§YubiKeyã«è¨­å®šã•ã‚ŒãŸå†…å®¹ãŒè¡¨ç¤ºã§ãã‚‹ã€‚

```shell
$ gpg --card-status
Reader ...........: Yubico Yubikey 4 OTP U2F CCID
Application ID ...: 00000000000000000000000000000000
Application type .: OpenPGP
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 00000000
Name of cardholder: [æœªè¨­å®š]
Language prefs ...: [æœªè¨­å®š]
Salutation .......: 
URL of public key : [æœªè¨­å®š]
Login data .......: [æœªè¨­å®š]
Signature PIN ....: å¼·åˆ¶ãªã—
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 0
KDF setting ......: off
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
```

## PINã®è©¦è¡Œå¯èƒ½å›æ•°ã‚’è¨­å®šã™ã‚‹

[`ykman openpgp access set-retries`](https://docs.yubico.com/software/yubikey/tools/ykman/OpenPGP_Commands.html#ykman-openpgp-access-set-retries-options-pin-retries-reset-code-retries-admin-pin-retries) ã§PINã®è©¦è¡Œå¯èƒ½å›æ•°ã‚’è¨­å®šã§ãã‚‹ã€‚
å¼•æ•°ã«ã¯ `PIN-RETRIES RESET-CODE-RETRIES ADMIN-PIN-RETRIES` ã®é †ã§3ã¤ã®æ•°å­—ã‚’æŒ‡å®šã™ã‚‹ã€‚
è¨­å®šã—ã¦ã‚‚ `gpg --card-status` ã§RESET CODEã®ãƒªãƒˆãƒ©ã‚¤å›æ•°ãŒ0ã®ã¾ã¾ãªã®ã¯ã‚ˆãã‚ã‹ã‚‰ãªã„ã€‚

```shell
$ ykman openpgp access set-retries 5 5 5
Enter Admin PIN: (Admin PINã‚’å…¥åŠ›)
Set PIN retry counters to: 5 5 5? [y/N]: y
$ gpg --card-status | grep 'PIN retry'
PIN retry counter : 5 0 5
```

## OpenPGPé–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨æ¶ˆå»ã™ã‚‹

ã‚¼ãƒ­ã‹ã‚‰ã‚„ã‚Šç›´ã—ãŸã„å ´åˆãªã©ã¯ã€ `ykman openpgp reset` ã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã§ãã‚‹ã€‚ã»ã‚“ã¨ã†ã«å…¨ã¦ãŒæ¶ˆãˆã‚‹ã®ã§æ³¨æ„ã™ã‚‹ã€‚
`gpg --card-edit` ã‹ã‚‰ `admin` â†’ `factory-reset` ã§ã‚‚ã€ã»ã¼åŒã˜ã“ã¨ãŒã§ãã‚‹ã¨æ€ã†ã€‚

```shell
$ ykman openpgp reset
WARNING! This will delete all stored OpenPGP keys and data and restore factory settings? [y/N]: y
Resetting OpenPGP data, don't remove the YubiKey...
Success! All data has been cleared and default PINs are set.
PIN:         123456
Reset code:  NOT SET
Admin PIN:   12345678
```

## å‚è€ƒãƒªãƒ³ã‚¯

- [developers.yubico.com/PGP/](https://developers.yubico.com/PGP/)
- [Using Your YubiKey with OpenPGP](https://support.yubico.com/hc/en-us/articles/360013790259-Using-Your-YubiKey-with-OpenPGP)
- [YubiKey Manager (ykman) CLI and GUI Guide](https://docs.yubico.com/software/yubikey/tools/ykman/index.html)
- [The GnuPG Smartcard HOWTO](https://gnupg.org/howtos/card-howto/en/smartcard-howto.html)
- [Setting up ssh public key authentication on macOS using a YubiKey 4](https://gist.github.com/ixdy/6fdd1ecea5d17479a6b4dab4fe1c17eb)
- [drduh/YubiKey-Guide](https://github.com/drduh/YubiKey-Guide)
